@inject IUserService userService;
@inject SweetAlertService Swal


@page "/useradminmanage"
@using CurrieTechnologies.Razor.SweetAlert2
@using GYM_DTOs.AccountDTO
@attribute [Authorize(Roles = "Instructor")]

<style>
    .imgCard {
        width: 20%;
    }

    .card {
        border: 1px solid rgba(0, 0, 0, .125);
        border-radius: .25rem;
    }

    .row-user {
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        /* margin-right: -15px; */
        /* margin-left: -15px; */
    }

    .row-user {
        --bs-gutter-x: 1.5rem;
        --bs-gutter-y: 0;
        display: flex;
        flex-wrap: wrap;
        margin-top: calc(var(--bs-gutter-y)* -1);
        /* margin-right: calc(var(--bs-gutter-x)* -.5); */
        /* margin-left: calc(var(--bs-gutter-x)* -.5); */
    }

</style>

<h2>Usuarios del sistema</h2>

<h4 class="mt-5">Administradores</h4>

<div class="row-user row-cols-1 row-cols-md-2 row-cols-lg-3">
    <!-- Tarjeta de ejemplo -->
    @if (listAdmin is null)
    {
        <img style="width: 50px" src="https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif" />
    }
    else
    {
        @foreach (var user in listAdmin)
        {
            <div class="col mb-4">
                <div class="card h-100">
                    <img src="img/CardUserImg.png" class="card-img-top mx-auto imgCard" alt="Imagen de usuario">
                    <div class="card-body text-center">
                        <h5 class="card-title">@user.Username</h5>
                        <p class="card-text">Correo electrónico: @user.Email</p>
                        <p class="card-text">Rol: @user.Rol</p>
                    </div>
                </div>
            </div>
        }
    }
</div>

<h4 class="mt-5">Usuarios</h4>

<div class="row-user row-cols-1 row-cols-md-2 row-cols-lg-3">
    @if (listUser is null)
    {
        <img style="width: 50px" src="https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif" />

    }
    else
    {

        @foreach (var user in listUser)
        {
            <!-- Tarjeta de ejemplo -->
            <div class="col mb-4">
                <div class="card h-100">
                    <img src="img/CardUserImg.png" class="card-img-top mx-auto imgCard" alt="Imagen de usuario">
                    <div class="card-body text-center">
                        <h5 class="card-title">@user.Username</h5>
                        <p class="card-text">Correo electrónico: @user.Email</p>
                        <p class="card-text">Rol: @user.Rol</p>
                        <button href="#" class="btn btn-primary">Editar</button>
                        <button class="btn btn-success" @onclick="(() => HacerAdmin(user.Id))">Hacer Admin</button>
                        <button class="btn btn-danger">Dar de baja</button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {

    UserListResult resultUser = null;
    List<UserDTO> listAdmin = null;
    List<UserDTO> listUser = null;

    protected override async Task OnInitializedAsync()
    {
        resultUser = await userService.UserList();
        listAdmin = resultUser.ListUser.Where(x => x.Rol == "Instructor").ToList();
        listUser = resultUser.ListUser.Where(x => x.Rol == "User").ToList();

    }

    private async Task HacerAdmin(string id)
    {
        string idUser = id;

        var result = await userService.MakeAdmin(idUser);

        if (result.EsCorrecto)
        {
            var resultado = await Swal.FireAsync(new SweetAlertOptions
                {
                    Title = "Correcto",
                    Text = "Se ha cambiado correctamente el rol a Instructor",
                    Icon = SweetAlertIcon.Success
                });
            resultUser = await userService.UserList();
            listAdmin = resultUser.ListUser.Where(x => x.Rol == "Instructor").ToList();
            listUser = resultUser.ListUser.Where(x => x.Rol == "User").ToList();
        }
        else
        {
            var resultado = await Swal.FireAsync(new SweetAlertOptions
                {
                    Title = "Error",
                    Text = result.Mensaje,
                    Icon = SweetAlertIcon.Error
                });
        }
    }

}
